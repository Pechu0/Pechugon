<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GBA.js</title>
    <link rel="stylesheet" href="resources/main.css">
    <link rel="shortcut icon" href="favicon.ico">
    
    <script src="js/util.js"></script>
    <script src="js/core.js"></script>
    <script src="js/arm.js"></script>
    <script src="js/thumb.js"></script>
    <script src="js/mmu.js"></script>
    <script src="js/io.js"></script>
    <script src="js/audio.js"></script>
    <script src="js/video.js"></script>
    <script src="js/video/proxy.js"></script>
    <script src="js/video/software.js"></script>
    <script src="js/irq.js"></script>
    <script src="js/keypad.js"></script>
    <script src="js/sio.js"></script>
    <script src="js/savedata.js"></script>
    <script src="js/gpio.js"></script>
    <script src="js/gba.js"></script>
    <script src="resources/xhr.js"></script>

    <script>
        let gba, runCommands = [], debug = null;

        function initAudioContext() {
            if (gba?.audio?.context?.state === 'suspended') {
                gba.audio.context.resume().catch(err => console.error('Error al reanudar AudioContext:', err));
                console.log('AudioContext reanudado');
            }
        }

        function run(file) {
    initAudioContext();

    if (!(file instanceof Blob)) {
        console.error("El archivo no es un Blob o File");
        return;
    }

    gba.loadRomFromFile(file, result => {
        if (result) {
            gba.rom = file;
            gba.runStable();
            showControls();
        } else {
            console.error("Error al cargar el ROM");
        }
    });
    }
        function showControls() {
            document.getElementById('preload').classList.add('hidden');
            document.getElementById('ingame').classList.remove('hidden');
        }

        function loadRomFromUrl(url) {
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Error al descargar el ROM');
                    return response.arrayBuffer();
                })
                .then(romData => {
                    console.log('ROM descargado correctamente:', romData);
                    run(new Blob([romData], { type: 'application/octet-stream' }));
                })
                .catch(error => console.error('Error cargando el ROM desde la URL:', error));
        }

        function loadSelectedRom() {
            const selectedRom = document.getElementById('romSelect').value;
            const romUrl = `https://raw.githubusercontent.com/Pechu0/Pechugon/main/ROMs/${selectedRom}`;
            console.log("Cargando ROM desde: " + romUrl);
            loadRomFromUrl(romUrl);
        }

        function reset() {
            if (!gba) {console.error("No se ha inicializado correctamente el objeto gba.");
            alert("No se ha inicializado correctamente el emulador.");
            return;}
        
            gba.pause();
            gba.reset();
            const canvas = document.getElementById('screen');
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        
            loadSelectedRom();

            if (gba.rom instanceof Blob) {
                gba.loadRomFromFile(gba.rom, result => {
                    if (result) {
                        console.log("ROM recargado correctamente, ejecutando...");
                        gba.runStable();
                    } else {
                        console.error("Error al recargar el ROM");
                        alert("Ocurrió un error al recargar el ROM.");
                    }
                });
            } else {
                console.error("No hay un ROM válido para recargar");
                alert("No hay un ROM válido para recargar.");
            }
        }

        function setVolume(volume) {
            if (gba?.audio) {
                gba.audio.masterVolume = volume / 100;
            }
        }

        window.onload = function() {
            try {
                gba = new GameBoyAdvance();
                gba.keypad.eatInput = true;
                gba.setLogger((level, error) => {
                    console.log(error);
                    gba.pause();
                    if (!gba) {
                    console.error("No se ha inicializado correctamente el objeto gba.");
                    return;
                    }
                    if (document.getElementById('screen').getAttribute('class') === 'dead') {
                        console.log('We appear to have crashed multiple times without resetting.');
                        return;
                    }
                    const crashImg = document.createElement('img');
                    crashImg.id = 'crash';
                    crashImg.src = 'resources/crash.png';
                    screen.parentElement.insertBefore(crashImg, screen);
                    screen.setAttribute('class', 'dead');
                });
            } 
            catch (exception) {
                gba = null;
            }

            if (gba && FileReader) {
                const canvas = document.getElementById('screen');
                gba.setCanvas(canvas);
                gba.logLevel = gba.LOG_ERROR;

                loadRom('resources/bios.bin', bios => {
                    gba.setBios(bios);
                });

                if (!gba.audio.context) {
                    const soundbox = document.getElementById('sound');
                    if (soundbox) soundbox.remove();
                }

                if (window.navigator.appName === 'Microsoft Internet Explorer') {
                    const pixelatedBox = document.getElementById('pixelated');
                    if (pixelatedBox) pixelatedBox.remove();
                }
            } else {
                const controls = document.getElementById('controls');
                if (controls) controls.remove();
            }
            const canvas = document.getElementById('screen');
            if (canvas && gba) {
                gba.setCanvas(canvas);
            } else {
                console.error("No se encontró el canvas o gba no está inicializado");
            }
        };
    </script>
</head>
<body>
    <canvas id="screen" width="480" height="320"></canvas>
    <section id="controls">
        <div id="preload">
            <select id="romSelect">
                <option value="Mega%20Man%20Battle%20Network%20(USA).gba">Mega Man Battle Network US</option>
                <option value="The%20Sims%20-%20Bustin%20Out.gba">The Sims</option>
                <option value="Harry%20Potter%20and%20the%20Sorcerers%20Stone.gba">Harry Potter y la piedra filosofal</option>
                <option value="0776%20-%20The%20Legend%20Of%20Zelda%20-%20A%20Link%20To%20The%20Past%20(U)(Mode7).gba">The legend of zelda a link to the past</option>
                <option value="1268%20-%20Harvest%20Moon%20-%20Friends%20of%20Mineral%20Town%20(U)(Mode7).gba">Harvest moon - Friends of mineral</option>
                <option value="1691%20-%20Pokemon%20Leaf%20Green%20(U)(Independent).gba">Pokemon hoja verdosa</option>
                <option value="1695%20-%20Pokemon%20Fire%20Red%20(U)(Independent).gba">Pokemon fuego caliente</option>
                <option value="1728%20-%20Grand%20Theft%20Auto%20Advance%20(U)(Mode7).gba">GTA Advance</option>
                <option value="1755%20-%20Metal%20Slug%20Advance%20(U)(Independent).gba">Metal slug Advance</option>
                <option value="1865%20-%20The%20Legend%20of%20Zelda%20-%20The%20Minish%20Cap%20(U)(DCS).gba">The legend of zelda Minish cap</option>
                <option value="1952%20-%20Mario%20Party%20Advance%20(U)(Endless%20Piracy).gba">Mario Party Advance</option>
                <option value="1970%20-%20Popeye%20-%20Rush%20for%20Spinach%20(U)(Endless%20Piracy).gba">Popeye adiccion a espinaca</option>
                <option value="1986%20-%20Pokemon%20Emerald%20(U)(TrashMan).gba">Pokemon collar de esmeralda</option>
                <option value="2233%20-%20King%20Kong%20(E)(Rising%20Sun).gba">King kong</option>
                <option value="2334%20-%20Naruto%20-%20Ninja%20Council%20(U)(Trashman).gba">Naruto Nunja council</option>
            </select>
            <button class="bigbutton" id="loadRomButton" onclick="loadSelectedRom()">Cargar ROM</button>
        </div>
        <div id="ingame" class="hidden">
            <button id="pause" class="bigbutton" onclick="togglePause()">Pausar</button>
            <button class="bigbutton" onclick="reset()">Reiniciar</button>
            <button onclick="gba.downloadSavedata()">Descargar partida</button>
            <button onclick="screenshot()">Captura de pantalla</button>
            <label id="pixelated">
                <input type="checkbox" onchange="setPixelated(this.checked)">
                <p>Pixelado</p>
            </label>
            <div id="sound">
                <input type="checkbox" checked onchange="gba.audio.masterEnable = this.checked">
                <p>Sonido</p>
                <input type="range" min="0" max="100" value="50" step="any" onchange="setVolume(this.value)" oninput="setVolume(this.value)">
            </div>
            <p id="openDebug" onclick="enableDebug()">Debugger</p>
            });
            gba.setLogger((level, error) => {
            console.log("Error: ", error);
            gba.pause();
        </div>
    </section>
    <ul id="links">
        <li><a href="http://github.com/endrift/gbajs/">Fork me on GitHub!</a></li>
        <li><a href="https://github.com/endrift/gbajs/wiki/Compatibility-List">Compatibility list</a></li>
    </ul>
    <footer>© 2012 – 2013 <a href="http://endrift.com/">Jeffrey Pfau</a></footer>
</body>
</html>
