<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GBA.js</title>
    <link rel="stylesheet" href="resources/main.css">
    <script src="js/util.js"></script>
    <script src="js/core.js"></script>
    <script src="js/arm.js"></script>
    <script src="js/thumb.js"></script>
    <script src="js/mmu.js"></script>
    <script src="js/io.js"></script>
    <script src="js/audio.js"></script>
    <script src="js/video.js"></script>
    <script src="js/video/proxy.js"></script>
    <script src="js/video/software.js"></script>
    <script src="js/irq.js"></script>
    <script src="js/keypad.js"></script>
    <script src="js/sio.js"></script>
    <script src="js/savedata.js"></script>
    <script src="js/gpio.js"></script>
    <script src="js/gba.js"></script>
    <script src="resources/xhr.js"></script>
    <link rel="shortcut icon" href="favicon.ico">
    
    <script>
    var gba;
    var runCommands = [];
    var debug = null;

    function initAudioContext() {
        if (gba && gba.audio.context && gba.audio.context.state === 'suspended') {
            gba.audio.context.resume().then(() => {
                console.log('AudioContext reanudado');
            }).catch(err => {
                console.error('Error al reanudar AudioContext:', err);
            });
        }
    }

    // Función para manejar la carga del ROM desde archivo
    function run(file) {
        initAudioContext();

        if (!(file instanceof Blob)) {
            console.error("El archivo pasado no es un Blob o File");
            return;
        }

        gba.loadRomFromFile(file, function(result) {
            if (result) {
                gba.rom = file;
                gba.runStable();
                showControls();  // Mostrar controles cuando se carga el ROM
            } else {
                console.error("Error al cargar el ROM");
            }
        });
        gba.rom = file;
        console.log("ROM guardado en gba.rom:", gba.rom);
    }

    // Función para mostrar los controles
    function showControls() {
        document.getElementById('preload').classList.add('hidden');
        document.getElementById('ingame').classList.remove('hidden');
    }

    // Función para cargar el ROM desde URL
    function loadRomFromUrl(url) {
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al descargar el ROM');
                }
                return response.arrayBuffer();
            })
            .then(romData => {
                console.log('ROM descargado correctamente:', romData);
                var romBlob = new Blob([romData], { type: 'application/octet-stream' });
                run(romBlob);
            })
            .catch(error => console.error('Error cargando el ROM desde la URL:', error));
    }

    // Manejo de la selección de ROMs
    function loadSelectedRom() {
        var select = document.getElementById('romSelect');
        var selectedRom = select.value;
        var romUrl = 'https://raw.githubusercontent.com/Pechu0/Pechugon/main/ROMs/' + selectedRom;
        console.log("Cargando ROM desde: " + romUrl);
        
        initAudioContext();
        loadRomFromUrl(romUrl);
    }

function reset() {
    if (!gba) return;

    gba.pause();
    gba.reset();

    var canvas = document.getElementById('screen');
    var context = canvas.getContext('2d');
    context.clearRect(0, 0, canvas.width, canvas.height);

    // Aquí compruebas si gba.rom es válido antes de intentar recargar
    if (gba.rom && gba.rom instanceof Blob) {
        console.log("ROM encontrado y válido, intentando recargar...");
        gba.loadRomFromFile(gba.rom, function(result) {
            if (result) {
                console.log("ROM recargado correctamente, ejecutando...");
                gba.runStable();
                gba.rom = file;
                console.log("ROM guardado en gba.rom:", gba.rom);
            } else {
                console.error("Error al recargar el ROM");
            }
        });
    } else {
        // Manejo alternativo si no hay un ROM válido
        console.error("No hay un ROM válido para recargar");
    }
}


    // Función para ajustar el volumen
    function setVolume(volume) {
        if (gba && gba.audio) {
            gba.audio.masterVolume = volume / 100;  // Normalización del volumen a 0-1
        }
    }

    // Fusión de las funciones window.onload en una sola
    window.onload = function() {
        try {
            gba = new GameBoyAdvance();
            gba.keypad.eatInput = true;
            gba.setLogger(function(level, error) {
                console.log(error);
                gba.pause();
                var screen = document.getElementById('screen');
                if (screen.getAttribute('class') == 'dead') {
                    console.log('We appear to have crashed multiple times without resetting.');
                    return;
                }
                var crash = document.createElement('img');
                crash.setAttribute('id', 'crash');
                crash.setAttribute('src', 'resources/crash.png');
                screen.parentElement.insertBefore(crash, screen);
                screen.setAttribute('class', 'dead');
            });
        } catch (exception) {
            gba = null;
        }

        if (gba && FileReader) {
            var canvas = document.getElementById('screen');
            gba.setCanvas(canvas);

            gba.logLevel = gba.LOG_ERROR;

            loadRom('resources/bios.bin', function(bios) {
                gba.setBios(bios);
            });

            if (!gba.audio.context) {
                var soundbox = document.getElementById('sound');
                if (soundbox) {
                    soundbox.parentElement.removeChild(soundbox);
                }
            }

            if (window.navigator.appName === 'Microsoft Internet Explorer') {
                var pixelatedBox = document.getElementById('pixelated');
                if (pixelatedBox) {
                    pixelatedBox.parentElement.removeChild(pixelatedBox);
                }
            }
        } else {
            var dead = document.getElementById('controls');
            if (dead) {
                dead.parentElement.removeChild(dead);
            }
        }
    };
    </script>
</head>
<body>
    <canvas id="screen" width="480" height="320"></canvas>
    <section id="controls">
        <div id="preload">
            <select id="romSelect">
                <option value="Mega%20Man%20Battle%20Network%20(USA).gba">Mega Man Battle Network US</option>
                <option value="The%20Sims%20-%20Bustin%20Out.gba">The Sims</option>
                <option value="Harry%20Potter%20and%20the%20Sorcerers%20Stone.gba">Harry Potter y la piedra filosofal</option>
                <option value="Pokemon%20Sapphire.gba">Pokemon Zafiro</option>
            </select>
            <button class="bigbutton" id="loadRomButton" onclick="loadSelectedRom()">Cargar ROM</button>
        </div>
        <div id="ingame" class="hidden">
            <button id="pause" class="bigbutton" onclick="togglePause()">Pausar</button>
            <button class="bigbutton" onclick="reset()">Reiniciar</button>
            <button onclick="gba.downloadSavedata()">Descargar partida</button>
            <button onclick="screenshot()">Captura de pantalla</button>
            <label id="pixelated">
                <input type="checkbox" onchange="setPixelated(this.checked)">
                <p>Pixelado</p>
            </label>
            <div id="sound">
                <input type="checkbox" checked onchange="gba.audio.masterEnable = this.checked">
                <p>Sonido</p>
                <input type="range" min="0" max="100" value="50" step="any" onchange="setVolume(this.value)" oninput="setVolume(this.value)">
            </div>
            <p id="openDebug" onclick="enableDebug()">Debugger</p>
        </div>
    </section>
    <ul id="links">
        <li><a href="http://github.com/endrift/gbajs/">Fork me on GitHub!</a></li>
        <li><a href="https://github.com/endrift/gbajs/wiki/Compatibility-List">Compatibility list</a></li>
    </ul>
    <footer>© 2012 – 2013 <a href="http://endrift.com/">Jeffrey Pfau</a></footer>
</body>
</html>
