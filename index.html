<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>GBA.js</title>
<link rel="stylesheet" href="resources/main.css">
<script src="js/util.js"></script>
<script src="js/core.js"></script>
<script src="js/arm.js"></script>
<script src="js/thumb.js"></script>
<script src="js/mmu.js"></script>
<script src="js/io.js"></script>
<script src="js/audio.js"></script>
<script src="js/video.js"></script>
<script src="js/video/proxy.js"></script>
<script src="js/video/software.js"></script>
<script src="js/irq.js"></script>
<script src="js/keypad.js"></script>
<script src="js/sio.js"></script>
<script src="js/savedata.js"></script>
<script src="js/gpio.js"></script>
<script src="js/gba.js"></script>
<script src="resources/xhr.js"></script>
<link rel="shortcut icon" href="">
    
<script>
var gba;
var runCommands = [];
var debug = null;

try {
    gba = new GameBoyAdvance();
    gba.keypad.eatInput = true;
    gba.setLogger(function(level, error) {
        console.log(error);
        gba.pause();
        var screen = document.getElementById('screen');
        if (screen.getAttribute('class') == 'dead') {
            console.log('We appear to have crashed multiple times without reseting.');
            return;
        }
        var crash = document.createElement('img');
        crash.setAttribute('id', 'crash');
        crash.setAttribute('src', 'resources/crash.png');
        screen.parentElement.insertBefore(crash, screen);
        screen.setAttribute('class', 'dead');
    });
} catch (exception) {
    gba = null;
}

// Función que se llamará tras la interacción del usuario
function initAudioContext() {
    if (gba && gba.audio.context && gba.audio.context.state === 'suspended') {
        gba.audio.context.resume().then(() => {
            console.log('AudioContext reanudado');
        }).catch(err => {
            console.error('Error al reanudar AudioContext:', err);
        });
    }
}

window.onload = function() {
    if (gba && FileReader) {
        var canvas = document.getElementById('screen');
        gba.setCanvas(canvas);

        gba.logLevel = gba.LOG_ERROR;

        loadRom('resources/bios.bin', function(bios) {
            gba.setBios(bios);
        });

        if (!gba.audio.context) {
            var soundbox = document.getElementById('sound');
            soundbox.parentElement.removeChild(soundbox);
        }

    } else {
        var dead = document.getElementById('controls');
        dead.parentElement.removeChild(dead);
    }
}

function lcdFade(context, target, callback) {
    var i = 0;
    var drawInterval = setInterval(function() {
        i++;
        var pixelData = context.getImageData(0, 0, 240, 160);
        for (var y = 0; y < 160; ++y) {
            for (var x = 0; x < 240; ++x) {
                var xDiff = Math.abs(x - 120);
                var yDiff = Math.abs(y - 80) * 0.8;
                var xFactor = (120 - i - xDiff) / 120;
                var yFactor = (80 - i - ((y & 1) * 10) - yDiff + Math.pow(xDiff, 1 / 2)) / 80;
                pixelData.data[(x + y * 240) * 4 + 3] *= Math.pow(xFactor, 1 / 3) * Math.pow(yFactor, 1 / 2);
            }
        }
        context.putImageData(pixelData, 0, 0);
        target.clearRect(0, 0, 480, 320);
        if (i > 40) {
            clearInterval(drawInterval);
        } else {
            callback();
        }
    }, 50);
}
// Función que será llamada tras la carga del ROM
function run(file) {
    initAudioContext();  // Reanuda el AudioContext cuando el usuario selecciona el ROM
    
    // Verificar si el archivo es un Blob
    if (!(file instanceof Blob)) {
        console.error("El archivo pasado no es un Blob o File");
        return;
    }
    
    gba.loadRomFromFile(file, function(result) {
        if (result) {
            gba.rom = file;  // Guardar el archivo ROM en memoria
            gba.runStable();
        } else {
            console.error("Error al cargar el ROM");
        }
    });
}

    window.onload = function() {
    if (gba && FileReader) {
        var canvas = document.getElementById('screen');
        gba.setCanvas(canvas);

        gba.logLevel = gba.LOG_ERROR;

        loadRom('resources/bios.bin', function(bios) {
            gba.setBios(bios);
        });

        // Mueve la configuración del audio a una interacción basada en el usuario
        if (!gba.audio.context) {
            // Deja el cuadro de sonido si el sonido no está disponible
            var soundbox = document.getElementById('sound');
            soundbox.parentElement.removeChild(soundbox);
        }

        if (window.navigator.appName == 'Microsoft Internet Explorer') {
            // Elimina la opción pixelada si no funciona
            var pixelatedBox = document.getElementById('pixelated');
            pixelatedBox.parentElement.removeChild(pixelatedBox);
        }
    } else {
        var dead = document.getElementById('controls');
        dead.parentElement.removeChild(dead);
    }
}
    
function run(romData) {
    var pause = document.getElementById('pause');
    pause.textContent = "PAUSE";
    gba.loadRomFromFile(romData, function(result) {
        if (result) {
            for (var i = 0; i < runCommands.length; ++i) {
                runCommands[i]();
            }
            runCommands = [];
            fadeOut('preload', 'ingame');
            fadeOut('instructions', null, true);
            gba.runStable();
        } else {
            console.error("Failed to load ROM");
        }
    });
}

// Nueva función para cargar el ROM desde una URL con fetch y ArrayBuffer
// Nueva función para cargar el ROM desde una URL con fetch y ArrayBuffer
function loadRomFromUrl(url) {
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al descargar el ROM');
            }
            return response.arrayBuffer();  // Convertir el Response a ArrayBuffer
        })
        .then(romData => {
            console.log('ROM descargado correctamente:', romData);
            // Convertir el ArrayBuffer a Blob para usar con gba.loadRomFromFile
            var romBlob = new Blob([romData], { type: 'application/octet-stream' });
            run(romBlob);  // Pasar el Blob a la función run()
        })
        .catch(error => console.error('Error cargando el ROM desde la URL:', error));
}

// Función para manejar la selección de ROMs
function loadSelectedRom() {
    var select = document.getElementById('romSelect');
    var selectedRom = select.value;
    var romUrl = 'https://raw.githubusercontent.com/Pechu0/Pechugon/main/ROMs/' + selectedRom;
    console.log("Cargando ROM desde: " + romUrl);
    
    initAudioContext();  // Llama initAudioContext cuando se selecciona el ROM
    loadRomFromUrl(romUrl);  // Cargar el ROM desde la URL seleccionada
}
function reset() {
    if (!gba) return;  // Verificar que gba está inicializado
    
    gba.pause();       // Pausar el emulador actual
    gba.reset();       // Reiniciar el emulador (esto resetea todo, incluyendo los registros de la GBA)
    
    // Limpiar el canvas
    var canvas = document.getElementById('screen');
    var context = canvas.getContext('2d');
    context.clearRect(0, 0, canvas.width, canvas.height);
    
    // Verificar si ya hay un ROM cargado
    if (gba.rom && gba.rom instanceof Blob) {
        gba.loadRomFromFile(gba.rom, function(result) {
            if (result) {
                gba.runStable();  // Reiniciar la ejecución del emulador
            } else {
                console.error("Error al recargar el ROM");
            }
        });
    } else {
        console.error("No hay un ROM válido para recargar");
    }
}
    
    // Limpiar el canvas
    var canvas = document.getElementById('screen');
    var context = canvas.getContext('2d');
    context.clearRect(0, 0, canvas.width, canvas.height);
    
    // Si ya hay un ROM cargado, volverlo a cargar después del reset
    if (gba.rom) {
        gba.loadRomFromFile(gba.rom);   // Recargar el ROM que estaba en memoria con loadRomFromFile
        gba.runStable();        // Reiniciar la ejecución del emulador
    }
    
    // Si el botón de selección está presente, restablecer el evento onclick
    if (load) {
        load.onclick = function() {
            document.getElementById('loader').click();
        }
    }
    
    // Restaurar la pantalla de juego
    fadeOut('ingame', 'preload');
}
function fadeOut(id, nextId, kill) {
    var e = document.getElementById(id);  // Corrección aquí: getElementById
    var e2 = document.getElementById(nextId);  // Corrección aquí también
    if (!e) {
        return;
    }
    var removeSelf = function() {
        if (kill) {
            e.parentElement.removeChild(e);
        } else {
            e.setAttribute('class', 'dead');
            e.removeEventListener('webkitTransitionEnd', removeSelf);
            e.removeEventListener('oTransitionEnd', removeSelf);
            e.removeEventListener('transitionend', removeSelf);
        }
        if (e2) {
            e2.setAttribute('class', 'hidden');
            setTimeout(function() {
                e2.removeAttribute('class');
            }, 0);
        }
    }

    e.addEventListener('webkitTransitionEnd', removeSelf, false);
    e.addEventListener('oTransitionEnd', removeSelf, false);
    e.addEventListener('transitionend', removeSelf, false);
    e.setAttribute('class', 'hidden');
}

// Definición de la función setVolume
function setVolume(volume) {
    if (gba && gba.audio) {
        gba.audio.masterVolume = volume;  // Ajustar el volumen del emulador
    }
}
</script>
</head>
<body>
<canvas id="screen" width="480" height="320"></canvas>
<section id="controls">
    <div id="preload">
        <!-- Menú desplegable para seleccionar el ROM -->
        <select id="romSelect">
            <option value="Mega%20Man%20Battle%20Network%20(USA).gba">Mega Man Battle Network US</option>
            <option value="The%20Sims%20-%20Bustin%20Out.gba">The Sims</option>
            <option value="Harry%20Potter%20and%20the%20Sorcerers%20Stone.gba">Harry Potter y la piedra filosofica</option>
            <option value="Pokemon%20Sapphire.gba">Pokemon la esmeralda continua</option>
            <!-- Agrega más opciones aquí -->
        </select>
        <button class="bigbutton" id="loadRomButton" onclick="loadSelectedRom()">LOAD ROM</button>
    </div>
    <div id="ingame" class="hidden">
        <button id="pause" class="bigbutton" onclick="togglePause()">PAUSE</button>
        <button class="bigbutton" onclick="reset()">RESET</button>
        <button onclick="gba.downloadSavedata()">Download Savegame</button>
        <button onclick="screenshot()">Screenshot</button>
        <label id="pixelated">
            <input type="checkbox" onchange="setPixelated(this.checked)">
            <p>Pixelated</p>
        </label>
        <div id="sound">
            <input type="checkbox" checked onchange="gba.audio.masterEnable = this.checked">
            <p>Sound</p>
            <input type="range" min="0" max="100" value="1" step="any" onchange="setVolume(this.value)" oninput="setVolume(this.value)">
        </div>
        <p id="openDebug" onclick="enableDebug()">Debugger</p>
    </div>
</section>
<ul id="links">
    <li><a href="http://github.com/endrift/gbajs/">Fork me on GitHub!</a></li>
    <li><a href="https://github.com/endrift/gbajs/wiki/Compatibility-List">Compatibility list</a></li>
</ul>
<footer>© 2012 – 2013 <a href="http://endrift.com/">Jeffrey Pfau</a></footer>
</body>
</html>
</!DOCTYPE html>
